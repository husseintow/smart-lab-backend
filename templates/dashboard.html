{% extends "base.html" %}
{% block title %}Dashboard | Security Command{% endblock %}
{% block content %}
<header style="margin-bottom: 32px;">
  <h2 style="margin-bottom: 8px;">Security Overview</h2>
  <p class="muted">Real-time status and control of the lab security nodes.</p>
</header>

<div class="grid grid-4">
  <div class="card metric-card" id="cardArmed">
    <div class="metric-label">System State</div>
    <div id="stateArmed" class="metric-value">...</div>
  </div>
  <div class="card metric-card">
    <div class="metric-label">Total Events</div>
    <div id="mTotal" class="metric-value">0</div>
  </div>
  <div class="card metric-card danger">
    <div class="metric-label">Intrusions</div>
    <div id="mIntrusion" class="metric-value">0</div>
  </div>
  <div class="card metric-card success">
    <div class="metric-label">Normal Operations</div>
    <div id="mNormal" class="metric-value">0</div>
  </div>
</div>

<div class="grid grid-2">
  <div class="card" style="display: flex; flex-direction: column;">
    <h3>Active Controls</h3>
    <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 16px; margin-top: auto;">
      <button class="btn btn-success" onclick="armSystem()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        ARM
      </button>
      <button class="btn btn-danger" onclick="disarmSystem()">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
        </svg>
        DISARM
      </button>
      <button class="btn btn-primary" onclick="alarmTest()" style="grid-column: span 2;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
          <line x1="12" y1="9" x2="12" y2="13"></line>
          <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
        TRIGGER TEST ALARM
      </button>
      <button class="btn btn-outline" onclick="retrainModel()" id="retrainBtn" style="grid-column: span 2;">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M12 2v4"></path>
          <path d="M12 18v4"></path>
          <path d="M4.93 4.93l2.83 2.83"></path>
          <path d="M16.24 16.24l2.83 2.83"></path>
          <path d="M2 12h4"></path>
          <path d="M18 12h4"></path>
          <path d="M4.93 19.07l2.83-2.83"></path>
          <path d="M16.24 7.76l2.83-2.83"></path>
        </svg>
        RETRAIN NEURAL ENGINE
      </button>
    </div>
  </div>

  <div class="card">
    <h3>Engine Status</h3>
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <div>
        <div class="metric-label" style="margin-bottom: 4px;">Sync Status</div>
        <div id="serverTime" style="font-size: 15px; font-weight: 600; color: #fff;">Connecting...</div>
      </div>
      <div>
        <div class="metric-label" style="margin-bottom: 4px;">Last Training</div>
        <div id="trainedAt" style="font-size: 15px; font-weight: 600; color: #fff;">-</div>
      </div>
      <div>
        <div class="metric-label" style="margin-bottom: 4px;">Last Device Check-in</div>
        <div id="lastEventTime" style="font-size: 15px; font-weight: 600; color: #fff;">-</div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h3 style="margin-bottom: 0;">Simulation & Validation</h3>
    <div class="badge badge-success">VIRTUAL LAB ACTIVE</div>
  </div>
  <p class="muted" style="margin-bottom: 20px;">Use these controls to verify machine learning and safety logic without
    hardware interaction.</p>
  <div class="grid grid-2" style="gap: 12px;">
    <button class="btn btn-outline" onclick="simulateEvent(1, 0, '02')" title="Tests deterministic night-time override">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
      Simulate Intrusion (2 AM)
    </button>
    <button class="btn btn-outline" onclick="simulateEvent(1, 0, '12')" title="Tests ML classification vs Day rules">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.07" x2="5.64" y2="17.66"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
      Simulate Normal
    </button>
  </div>
</div>

<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
    <h3 style="margin-bottom: 0;">Recent Activity</h3>
    <a href="{{ url_for('page_events') }}" class="btn btn-outline" style="padding: 6px 12px; font-size: 12px;">View
      All</a>
  </div>
  <div class="table-wrap">
    <table id="latestTable">
      <thead>
        <tr>
          <th>Time</th>
          <th>Device Node</th>
          <th>Sensing</th>
          <th>Armed</th>
          <th>AI Prediction</th>
          <th>Label</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}